name: ðŸ’¡ Copilot Issue Suggester

on:
  schedule:
    - cron: "0 9 * * 1" # Monday 9:00 UTC
  workflow_dispatch:
    inputs:
      suggestion_type:
        description: "Type of suggestions to look for"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - security
          - performance
          - refactoring
          - testing
          - documentation
          - architecture
          - configuration
          - bugs
          - maintainability

permissions:
  contents: read
  issues: write

jobs:
  review:
    name: ðŸ” Analyze & Create Issues
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ðŸ¤– Analyze code and create issues with Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          SUGGESTION_TYPE: ${{ inputs.suggestion_type || 'all' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Build the prompt based on suggestion type
          if [ "$SUGGESTION_TYPE" = "all" ]; then
            CATEGORIES="Security, Performance, Refactoring, Testing, Documentation, Architecture, Configuration, Bugs, and Maintainability"
          else
            CATEGORIES="$SUGGESTION_TYPE"
          fi

          # Copilot CLI analyzes the repo and creates issues using its GitHub MCP Server
          copilot -p "
          You are analyzing this repository to find improvement suggestions. Follow these steps:

          1. FIRST: Use the GitHub MCP Server to list ALL available labels in this repository. 
             SAVE this list - you MUST use these labels when creating issues.

          2. SECOND: Use the GitHub MCP Server to review the last 5 issues in this repository to understand:
             - The language used (Spanish, English, etc.)
             - The title structure (emojis, prefixes like feat:, fix:, etc.)
             - The body structure (sections, formatting)
             - Which labels are typically assigned to each type of issue

          3. THIRD: Analyze all the code in this repository looking for improvements in: $CATEGORIES

          4. FOURTH: For each important suggestion found, create an issue in this repository.
             CRITICAL REQUIREMENTS for each issue:
             - Title: Follow EXACTLY the same style as existing issues
             - Language: Use the SAME language as existing issues  
             - Body: Use the SAME structure as existing issues
             - LABELS (MANDATORY): 
               * ALWAYS include the 'ðŸ’¡ suggestion' label on EVERY issue (this is REQUIRED)
               * ALSO add other appropriate labels based on the suggestion type (security, bug, enhancement, etc.)
               DO NOT create issues without the 'ðŸ’¡ suggestion' label!
             - Footer: Include 'This issue was automatically generated by Copilot CLI'

          Create individual issues for each important suggestion, not a single issue with everything.
          REMEMBER: Every issue MUST have the 'ðŸ’¡ suggestion' label plus other relevant labels!
          " --allow-all-tools

          echo "âœ… Copilot CLI analysis completed"
