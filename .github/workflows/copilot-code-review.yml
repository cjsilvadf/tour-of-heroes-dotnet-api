name: ðŸ’¡ Copilot Issue Suggester

on:
  schedule:
    - cron: "0 9 * * 1" # Monday 9:00 UTC
  workflow_dispatch:
    inputs:
      suggestion_type:
        description: "Type of suggestions to look for"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - security
          - performance
          - refactoring
          - testing
          - documentation
          - architecture
          - configuration
          - bugs
          - maintainability

permissions:
  contents: read
  issues: write

jobs:
  review:
    name: ðŸ” Analyze & Create Issues
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install GitHub Copilot CLI
        run: |
          curl -fsSL https://gh.io/copilot-install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ðŸ¤– Analyze code and create issues with Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          SUGGESTION_TYPE: ${{ inputs.suggestion_type || 'all' }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Copilot CLI analyzes the repo and creates issues using its GitHub MCP Server
          copilot --no-interactive << EOF
          Before analyzing the code, I need you to do the following:

          1. FIRST: Review the available labels in this repository using the GitHub MCP Server.
             Observe the naming pattern (emojis, prefixes, language, etc.) to use them correctly.

          2. SECOND: Review the last 5 issues in the repository to understand:
             - The language they use (Spanish, English, etc.)
             - The title structure (emojis, prefixes like feat:, fix:, etc.)
             - The body structure (sections used, formatting, etc.)
             - Which labels are typically assigned

          3. THIRD: Analyze all the code in the repository.
             
             SUGGESTION TYPE REQUESTED: $SUGGESTION_TYPE

             If the type is "all", look for ALL these categories:
             - ðŸ” Security: vulnerabilities, hardcoded secrets, input validation, authentication
             - ðŸš€ Performance: inefficient algorithms, N+1 queries, memory leaks, caching opportunities
             - â™»ï¸ Refactoring: code smells, duplicated code, complex methods, SOLID principles
             - ðŸ§ª Testing: missing tests, edge cases, test coverage, test quality
             - ðŸ“– Documentation: missing docs, outdated comments, README improvements, API docs
             - ðŸ—ï¸ Architecture: design patterns, separation of concerns, dependency injection
             - âš™ï¸ Configuration: environment variables, settings, CI/CD improvements
             - ðŸ› Bugs: potential bugs, error handling, null checks, race conditions
             - ðŸ”§ Maintainability: code readability, naming conventions, file organization

             If a specific type is requested, focus ONLY on that category:
             - security â†’ ðŸ” Security improvements only
             - performance â†’ ðŸš€ Performance improvements only
             - refactoring â†’ â™»ï¸ Refactoring improvements only
             - testing â†’ ðŸ§ª Testing improvements only
             - documentation â†’ ðŸ“– Documentation improvements only
             - architecture â†’ ðŸ—ï¸ Architecture improvements only
             - configuration â†’ âš™ï¸ Configuration improvements only
             - bugs â†’ ðŸ› Bug detection only
             - maintainability â†’ ðŸ”§ Maintainability improvements only

          4. FOURTH: For each important suggestion, create an issue in this repository that:
             - Follows EXACTLY the same title style as existing issues
             - Uses the SAME language as existing issues
             - Has the SAME body structure as existing issues
             - Uses labels that EXIST in the repository and are appropriate for the type of improvement
             - Includes a footer indicating it was automatically generated by Copilot CLI

          Create individual issues for each important suggestion, not a single issue with everything.
          EOF

          echo "âœ… Copilot CLI analysis completed"
